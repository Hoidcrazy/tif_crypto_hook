# TIF和DWG文件透明加解密系统

## 项目概述
本系统实现对TIF图像文件的透明加密保护，核心功能包括：
- 文件加密：对TIF文件执行逐字节异或操作（^0xFF）
- 实时解密：应用程序读取时自动解密
- 透明处理：无需修改现有应用程序
- 安全存储：硬盘中始终存储加密格式
适用于麒麟v10 SP1 2403及兼容Linux系统环境。

## 需求分析
- 加上企业文件头：const unsigned char FLAG[4096] = {
    0xFF, 0xF7, 0xF0, 0x7F, 0x77, 0x70, 0x0F, 0x07, 0x07, 0x0F, 0x70, 0x77, 0x7F, 0xF0, 0xF7, 0xFF,
    0xC4, 0xCF, 0xBE, 0xA9, 0xBC, 0xAA, 0xD3, 0xA1, 0xD0, 0xC5, 0xCF, 0xA2, 0xBF, 0xC6, 0xBC, 0xBC,
    0xD3, 0xD0, 0xCF, 0xDE, 0xB9, 0xAB, 0xCB, 0xBE, 0xBC, 0xD3, 0xC3, 0xDC, 0xCE, 0xC4, 0xBC, 0xFE
};
- 离线加密 `.tif` 文件，算法为每个字节 `^ 0xFF`
- 存储在磁盘上的是“加密后”的图像数据
- 在应用程序读取加密文件时（如调用 `read`、`fread`、`ReadFile`、`mmap` 等），拦截系统调用。
- 读取加密后的文件后，在 buffer 中“实时解密”，即再执行 `^ 0xFF` 还原原始数据，最后进行输出。
- 能区分授信进程
- 确认可以写入

## 系统要求
- 操作系统：麒麟v10 SP1 2403或兼容Linux发行版
- 硬件：x86_64或ARM64架构
- 依赖库：
    - glibc 2.28+
    - pthread
    - libdl

## .so 注入条件
在 麒麟 V10 SP1 Desktop（2403）系统中，可以使用 LD_PRELOAD 将自己编写的 .so 动态库 注入到图片查看器中，以实现透明解密（或 hook 文件读取函数），但 前提是**该图片查看器是使用 glibc 动态链接的 ELF 可执行文件**。



# 透明解密并加密写回方案
本方案旨在实现对特定格式文件（如 .dwg）的**透明加解密**，即用户和应用程序无感知地完成“读取时自动解密、保存时自动加密”的全过程。整个过程基于 Linux 系统调用劫持（Hook）技术，在不修改 CAD 软件的前提下，保障文件在磁盘上始终以加密状态存储，而在内存中以明文形式供程序使用。

## 一、总体设计原则
- **透明性**：CAD 软件无需任何修改，像操作普通文件一样打开、编辑、保存。
- **安全性**：所有 .dwg 文件在磁盘上始终为加密状态，第三方工具无法直接读取内容。
- **完整性**：确保所有写回操作（无论通过 write、mmap + msync 或 munmap）都经过加密处理。
- **兼容性**：兼容不同打开方式（只读、读写）、不同保存机制（临时文件 + rename 等）。

## 二、核心机制：系统调用劫持（Hook）
通过 LD_PRELOAD 机制，替换标准 C 库中的文件 I/O 函数，插入自定义逻辑，实现对关键系统调用的拦截与处理。

## 三、读取流程：透明解密
当 CAD 打开一个 .dwg 文件时，触发以下流程：

### open / openat Hook
- 拦截文件打开操作。判断文件路径是否为 .dwg 文件且位于目标目录中。若是，则记录该文件描述符（fd）为“需加解密对象”，并继续原始 open 操作。

### read / pread64 解密
- 拦截 read 调用。
- 若 fd 被标记为需解密，则从磁盘读取的是密文数据。
- 在返回给 CAD 前，对缓冲区数据执行解密算法（异或 0xFF），转换为明文后再返回。
- CAD 收到的是明文，可正常解析和显示。

### mmap64 / mmap 解密（关键路径）
- 拦截 mmap 调用。
- 若映射的是 .dwg 文件，则先让系统完成原始映射（此时内存中是密文）。
- 使用 mprotect 临时将映射区域设为可写。
- 对映射内存中的数据执行解密操作，变为明文。
- 再用 mprotect 恢复原始权限（如只读）。
- CAD 读取该内存区域时，看到的是已解密的明文内容。

## 四、写入流程：加密写回
当用户编辑后保存文件，需确保所有修改以加密形式写回磁盘。

### write / pwrite64 加密
- 拦截写操作。
- 若 fd 对应加密文件，则在写入前对缓冲区中的明文数据进行加密。
- 将加密后的数据交给原始 write 函数写入磁盘。
- 实现“明文 → 密文”转换。

### msync 加密（mmap 场景）
- 当 CAD 调用 msync 同步内存到文件时，拦截该调用。
- 判断同步区域是否属于已解密的 .dwg 映射。
- 若是，则在同步前对内存中的明文数据进行加密。
- 执行原始 msync，将密文写回磁盘。

### munmap 加密（兜底机制）
- 鉴于 msync 并非强制调用，必须在 munmap 中做最终保障。
- 拦截 munmap，检查待解除映射的内存区域是否为 .dwg 文件映射。
- 如果是且数据被修改过，在解除映射前对内存中的明文执行加密。
- 确保即使未调用 msync，修改也能以密文形式落盘。

## 五、文件识别机制优化
为避免因 rename、临时文件等机制导致识别失败，采用多维度判断：
- **路径匹配**：检查文件路径是否以 .dwg 结尾。
- **文件头特征识别**：读取文件前若干字节，若为特定加密特征（如 be bc ce bb），则判定为加密文件，必须解密。
- **inode 缓存**：记录已处理文件的 inode，防止重复处理。
优先使用**文件头特征**作为判断依据，确保即使文件被移动或重命名，仍能正确识别。

## 六、异常与边界处理
- **只读文件处理**：若文件权限为只读，mmap 后仍可临时 mprotect 为可写进行解密，完成后恢复权限。
- **并发访问**：使用锁机制防止多线程下同时修改同一映射区域。
- **大文件分页处理**：对超大文件采用分页解密/加密，避免内存压力。
- **错误恢复**：若加密失败，阻止写入并报错，防止数据泄露。

## 七、验证方式
- 使用 hexdump 查看磁盘文件：始终显示为密文（如 be bc ce...）。
- 使用第三方软件打开文件：无法解析，验证加密有效。
- CAD 正常打开、编辑、保存、重新打开：流程顺畅，图形正确，验证透明性。

## 八、总结
本方案通过全面 Hook 文件 I/O 路径，结合 “读时解密、写时加密” 的闭环设计，实现了对 .dwg 文件的透明加解密保护。重点解决了 mmap 场景下的内存解密、msync 与 munmap 的双保险加密写回、以及 rename 机制下的文件识别等问题，确保在各种使用场景下都能安全、稳定运行。